<!DOCTYPE HTML>
<html>
<head>
<title>Block Domains</title>
<script type="text/javascript" src="./Scripts/jquery-1.7.1.min.js"></script>
</head>
<script type="text/javascript">
var block_list = safari.extension.settings.blocked_domains;

function blockDomain(){
  event.target.page.dispatchMessage("theBlock", "blocked")
}

// second function call
function respondToMessage(theMessageEvent) {
  if(theMessageEvent.name === "calcThis"){
    var startVal=theMessageEvent.message;
    bigCalc(startVal, theMessageEvent);
  }
  if (theMessageEvent.name === "blockThis"){
    //theMessageEvent.message.style.background = "red";
    blockDomain('test', theMessageEvent);
  }
}


/******************************
Command Functions
******************************/
/*
function validateCommand(event){
  if (event.command === "block-domain"){
    //pass
  }
}


safari.application.addEventListener("contextmenu", handleContextMenu, false);
 
function handleContextMenu(event) {
   if (event.userInfo === "IMG") {
     event.contextMenu.appendContextMenuItem("enlarge", "Enlarge Item");
    }
}


 
// message handling
safari.application.addEventListener("message", respondToMessage, false);

// interaction with the context/command menu
//safari.application.addEventListener("command", performCommand, false)
safari.application.addEventListener("validate", validateCommand, false)


*/



// was safari.application
// Register for the contextmenu event in the application layer.
safari.application.activeBrowserWindow.activeTab.addEventListener("contextmenu", handleContextMenu, false);
// Register for the command event to perform the context menu item's action when it is clicked.
safari.application.activeBrowserWindow.activeTab.addEventListener("command", handleCommand, false);
 



// append a context menu when appropriate
function handleContextMenu(event){
  // preliminary check to make sure we're grabbing a link with an "l" ("L") class
  if (event.userInfo && event.userInfo.tagName !== "A"){
    return;
  }
  event.contextMenu.appendContextMenuItem("block-domain", "Block Domain from Search Results");
}

// handle the command
function handleCommand(event){
  if (event.command !== "block-domain")
    return;
  // block the domain
  safari.application.activeBrowserWindow.activeTab.page.dispatchMessage("block-domain");
}

function blockDomains(){
  var ol = document.getElementById('ires').firstElementChild;
  var li = ol.getElementsByTagName('li');
  for (item in li){
    // only grab the search results DIV, skip the news
    if (li[item].className == "g" && li[item].id != "newsbox"){
      var linkHandle = li[item].firstElementChild.firstElementChild;  // handle for the actual link
      var testURL = normalizeURL(linkHandle.firstElementChild)[0];  // actual URL
      var testDomain = normalizeURL(linkHandle.firstElementChild)[1];  // actual domain

      // loop thru our localStorage items and block results from our blocklist
      for (var i=0; i < localStorage.length; i++) {
        if (testDomain == localStorage.key(i)){
          blockResult(linkHandle);  
        }
      };
    }
  }
}

</script>
</head>
<body>
</body>
</html>