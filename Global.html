<!DOCTYPE HTML>
<script type="text/javascript">
/*
Our Global.html page:

- Provides an interface to the Extension Preference pane in Safari
- Sends messages to our Injected.js script
- Listens for messages from the Extension Preference page
- Can NOT interface directly with the web page we are visiting
- Is NOT displayed to the user
- Is loaded once per browser session, regardless of the number of tabs opened.
- Can provide interactive interfaces to the user (e.g. JS alerts)
- Can NOT interface with localStorage in the same context as Injected.js

To do:

- Move Injected.js functions to the Global.html page, and pass those functions to Injected.js to lighten the page load
- Move the Safari settings to a Toolbar icon
- Create a user interface for manual addition/deletion of rules
- Allow for regular expressions in rules
- Add a setting for dimming of ads and/or blocked elements rather than hiding

*/

// number of blocked sites on the page
alert('global loaded');
var blockedSites = safari.extension.settings.blockedSites;


// Register for the validate and command events.
safari.application.addEventListener("validate", performValidate, false);
safari.application.addEventListener("command", performCommand, false);
//
safari.extension.settings.addEventListener("change", performSetting, false);



function performValidate(event)
{
    // Switch based on the command of the event. You should always check the command.
    console.log(event.command);
    switch (event.command) {
    case "show-messages":  // this is an example
        // Set the badge of the target, if the target has a badge property.
        // Some targets that send commands, like context menu items, don't have badges.
        if ("badge" in event.target)
            event.target.badge = unreadMessages;
        break;
    case "show-blocked":
        if ("badge" in event.target)
            event.target.badge = blockedSites;
        break;
    }
}


/*

function validateHandler(event)
{
    if (event.command === "reload-page") {
        // Disable the button if there is no URL loaded in the tab.
        event.target.disabled = !event.target.browserWindow.activeTab.url;
    }

    var itemArray = safari.extension.toolbarItems;
    alert(safari.extension.toolbarItems.count)
    for (var i = 0; i < itemArray.length; ++i) {
        var item = itemArray[i];
        if (item.identifier == "jaydorsey-block-toolbar")
        {
            item.badge = 25;
            console.log('test');
        }
    }
}
*/

function performCommand(event)
{
    // Switch based on the command of the event. You should always check the command.
    switch (event.command) {
    case "show-messages":
        // Show an alert with the number of messages.
        alert("You marked " + unreadMessages + " messages as read. Have a nice day!");

        // Reset the unread messages back to 0.
        updateUnreadMessageCount(0);
        break;
    case "show-blocked":
        alert("Badged@");

        break;
    }
}









function performSetting(event)
{
    /*
    if (event.key == "resetPopup") {
        resetLocalStorage();
    }
    if (event.key == "toggleAds") {
        toggleAds();
    }*/

    switch (event.command) { // or event.key?
    case "resetPopup":  // this is an example
        resetLocalStorage();
        break;
    case "toggleAds":
        toggleAds();
        break;
}




// reset all of our localStorage settings
function resetLocalStorage() {
    if (safari.extension.settings.resetPopup == "No") {
        return;
    }
    resetConfirm = confirm("Reset your personal blocklist?");
    if (resetConfirm) {
        // pass a message to injected to reset storage
        safari.application.activeBrowserWindow.activeTab.page.dispatchMessage("resetMessageFromGlobal", "true");
        alert("Your settings have been reset. Your page will reload.");
        currentURL = safari.application.activeBrowserWindow.activeTab.url;
        if (currentURL) {
            safari.application.activeBrowserWindow.activeTab.url = currentURL;
        }
    }
    // remove the listener
    safari.extension.settings.removeEventListener("change");
    // reset the setting
    safari.extension.settings.setItem("resetPopup", "No");
    // add the listener again. this prevents a loop
    safari.extension.settings.addEventListener("change", settingChanged, false);
}

function toggleAds() {
    switch (safari.extension.settings.toggleAds) {
    case true:
        safari.application.activeBrowserWindow.activeTab.page.dispatchMessage("toggleAdsFromGlobal", true);
        break;
    case false:
        safari.application.activeBrowserWindow.activeTab.page.dispatchMessage("toggleAdsFromGlobal", false);
        break;
    }
}

function remoteStorage(domain){
  //var newTab = safari.self.browserWindow.openTab();
}

function respondToMessage(messageEvent){
    console.log('in response');
    switch (messageEvent.name){
        case "block-domain":
            console.log("blocking domain");
            var domain = messageEvent.message;
            alert('blocking ' domain);
            // this was going to be testing for a web-service to store results remotely
            //var myTab = browserWindow.openTab('http://127.0.0.1:4567/add/'+domain)
            //myTab..close();
            //myTab.addEventListener("open", tabOpenHandler, true)
        break;
        default:
            alert("unhandled!");
        break;
    }
}


// wait for message from injected
// source: https://github.com/josephschmitt/Embedinator/blob/master/Embedinator.safariextension/global.html
/*
safari.application.addEventListener("message", function(e) {
    //Get references
    curTab = e.target;

    safari.extension.toolbarItems.forEach(function(item) {
        if (item.identifier == 'jaydorsey-block-toolbar') {
            button = item;
        }
    });

    //Extension INIT
    if (e.name == 'init') {
        updateSettings({
            autorun: safari.extension.settings.autorun,
            showBadge: safari.extension.settings.showBadge
        });

        if (settings.showBadge) {
            getBadgeCount();
        }
    }
    else if (e.name == 'updateBadge') {
      alert('test');
        button.badge = e.message.count;
    }
},false);
*/

//alert(safari.extension.toolbarItems.count);
/*
safari.extension.toolbarItems.forEach(function(item) {
    if (item.identifier == 'jaydorsey-block-toolbar') {
        button = item;
        button.badge = 15;
    }
});
*/




/*
  Wait for message from injected
*/
//safari.application.activeBrowserWindow.activeTab.addEventListener("message", respondToMessage, false);

</script>
